<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTO ME | Instagram Automation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e', // Green for success/money
                            600: '#16a34a',
                            900: '#14532d',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            border: '#334155'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Compat for simplicity in vanilla JS) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* dark-bg */
            color: #f8fafc;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-text {
            background: linear-gradient(to right, #4ade80, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #22c55e;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hide { display: none !important; }
        
        /* Smooth transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav id="navbar" class="w-full glass-panel sticky top-0 z-50 border-b border-gray-800 hide">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-2 cursor-pointer" onclick="router.navigate('dashboard')">
                    <i class="fa-brands fa-instagram text-brand-500 text-2xl"></i>
                    <span class="font-bold text-xl tracking-tight">AUTO<span class="text-brand-500">ME</span></span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <button onclick="router.navigate('dashboard')" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fa-solid fa-border-all mr-2"></i>Dashboard
                        </button>
                        <button onclick="router.navigate('automations')" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fa-solid fa-robot mr-2"></i>My Automations
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <img id="nav-user-img" src="" class="h-8 w-8 rounded-full border border-gray-600" alt="User">
                        <span id="nav-user-name" class="text-sm font-medium text-gray-300 hidden sm:block">User</span>
                    </div>
                    <button onclick="authService.logout()" class="text-gray-400 hover:text-white transition">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow w-full relative">
        
        <!-- View: Landing -->
        <section id="view-landing" class="absolute inset-0 flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1611162617474-5b21e879e113?q=80&w=1974&auto=format&fit=crop')] bg-cover bg-center">
            <div class="absolute inset-0 bg-dark-bg/90"></div>
            <div class="relative z-10 max-w-3xl mx-auto text-center px-4 fade-in">
                <div class="mb-6 inline-flex items-center justify-center p-3 bg-brand-500/10 rounded-full ring-1 ring-brand-500/50">
                    <i class="fa-brands fa-instagram text-brand-500 mr-2"></i>
                    <span class="text-brand-500 font-semibold text-sm">#1 Instagram DM Automation Tool</span>
                </div>
                <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight mb-6">
                    Turn Comments into <br> <span class="gradient-text">Sales on Autopilot</span>
                </h1>
                <p class="text-gray-400 text-lg md:text-xl mb-10 max-w-2xl mx-auto">
                    Automatically DM users who comment on your Reels. Boost engagement, deliver lead magnets, and close sales while you sleep.
                </p>
                <button onclick="authService.login()" class="group relative inline-flex items-center justify-center px-8 py-4 text-lg font-bold text-white transition-all duration-200 bg-brand-600 font-pj rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-600 hover:bg-brand-500 transform hover:-translate-y-1 shadow-lg shadow-brand-500/30">
                    <i class="fa-brands fa-instagram mr-3 text-2xl"></i>
                    Login with Instagram
                    <div class="absolute -top-3 -right-3 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-bounce">
                        FREE
                    </div>
                </button>
                <p class="mt-4 text-xs text-gray-500">Secure access via Facebook API</p>
            </div>
        </section>

        <!-- View: Dashboard (Reels Grid) -->
        <section id="view-dashboard" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hide fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-white">Select a Reel</h2>
                    <p class="text-gray-400 mt-1">Choose a content piece to automate.</p>
                </div>
                <button onclick="dataService.fetchReels()" class="text-sm text-brand-500 hover:text-brand-400 font-medium">
                    <i class="fa-solid fa-sync mr-1"></i> Refresh Reels
                </button>
            </div>

            <!-- Loading State -->
            <div id="reels-loading" class="flex justify-center py-20 hide">
                <div class="loader w-12 h-12"></div>
            </div>

            <!-- Grid -->
            <div id="reels-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Reels injected here -->
            </div>
        </section>

        <!-- View: Automation Builder -->
        <section id="view-builder" class="max-w-4xl mx-auto px-4 py-8 hide fade-in">
            <button onclick="router.navigate('dashboard')" class="text-gray-400 hover:text-white mb-6 flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> Back to Reels
            </button>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Left: Reel Preview -->
                <div class="md:col-span-1">
                    <div class="glass-panel rounded-xl overflow-hidden shadow-2xl sticky top-24">
                        <img id="builder-thumbnail" src="" class="w-full aspect-[9/16] object-cover opacity-80" alt="Reel">
                        <div class="p-4">
                            <h3 class="font-bold text-white text-lg mb-1">Selected Reel</h3>
                            <p id="builder-caption" class="text-gray-400 text-xs line-clamp-3 mb-2">Caption...</p>
                            <div class="flex items-center text-xs text-gray-500 gap-4">
                                <span><i class="fa-solid fa-eye mr-1"></i> <span id="builder-views">0</span></span>
                                <span><i class="fa-solid fa-heart mr-1"></i> <span id="builder-likes">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Form -->
                <div class="md:col-span-2">
                    <div class="glass-panel rounded-xl p-6 md:p-8">
                        <h2 class="text-2xl font-bold text-white mb-6">Configure Automation</h2>
                        
                        <form id="automation-form" onsubmit="automationService.save(event)">
                            <input type="hidden" id="form-reel-id">
                            <input type="hidden" id="form-reel-url">
                            <input type="hidden" id="form-reel-thumb">

                            <!-- Trigger -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Trigger Type</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="triggerType" value="keyword" class="peer sr-only" checked onchange="ui.toggleKeywordInput(true)">
                                        <div class="rounded-lg border border-gray-700 bg-dark-card p-4 hover:bg-gray-800 peer-checked:border-brand-500 peer-checked:bg-brand-500/10 transition text-center">
                                            <i class="fa-solid fa-key mb-2 text-xl text-gray-300 peer-checked:text-brand-500"></i>
                                            <div class="text-sm font-medium">Specific Keyword</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="triggerType" value="all" class="peer sr-only" onchange="ui.toggleKeywordInput(false)">
                                        <div class="rounded-lg border border-gray-700 bg-dark-card p-4 hover:bg-gray-800 peer-checked:border-brand-500 peer-checked:bg-brand-500/10 transition text-center">
                                            <i class="fa-solid fa-comments mb-2 text-xl text-gray-300 peer-checked:text-brand-500"></i>
                                            <div class="text-sm font-medium">Any Comment</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div id="keyword-group" class="mb-6">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Keyword to Match</label>
                                <input type="text" id="form-keyword" placeholder="e.g. 'GUIDE', 'Send me', 'PRICE'" class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-brand-500 transition">
                                <p class="text-xs text-gray-500 mt-1">Not case sensitive.</p>
                            </div>

                            <div class="mb-6 flex items-center justify-between p-4 bg-dark-bg rounded-lg border border-gray-700">
                                <div>
                                    <div class="text-sm font-medium text-white">Followers Only</div>
                                    <div class="text-xs text-gray-400">Only send DM if user follows you</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="form-follow-required" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                </label>
                            </div>

                            <!-- DM Content -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-400 mb-2">DM Message</label>
                                <textarea id="form-message" rows="3" placeholder="Hey! Thanks for your comment. Here is the link you asked for..." class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-brand-500 transition" required></textarea>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Button Text</label>
                                    <input type="text" id="form-btn-text" placeholder="Download Now" class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-brand-500 transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Button URL</label>
                                    <input type="url" id="form-btn-url" placeholder="https://..." class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-brand-500 transition">
                                </div>
                            </div>

                            <!-- Public Reply -->
                            <div class="mb-8">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Auto Reply to Comment</label>
                                <input type="text" id="form-reply" placeholder="Check your DMs! ðŸ‘€" class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-brand-500 transition">
                            </div>

                            <button type="submit" id="save-btn" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-4 rounded-lg shadow-lg shadow-brand-500/20 transition flex items-center justify-center">
                                <span id="save-btn-text">Activate Automation</span>
                                <div id="save-btn-loader" class="loader w-5 h-5 ml-2 hide border-white/30 border-l-white"></div>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- View: Automations List -->
        <section id="view-automations" class="max-w-5xl mx-auto px-4 py-8 hide fade-in">
            <h2 class="text-3xl font-bold text-white mb-8">My Automations</h2>
            
            <div id="automations-loading" class="flex justify-center py-20 hide">
                <div class="loader w-12 h-12"></div>
            </div>

            <div id="automations-list" class="space-y-4">
                <!-- List items injected here -->
            </div>
            
            <div id="no-automations" class="text-center py-20 hide">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-dark-card rounded-full mb-4 text-gray-600">
                    <i class="fa-solid fa-robot text-3xl"></i>
                </div>
                <h3 class="text-xl font-medium text-white">No automations yet</h3>
                <p class="text-gray-400 mt-2 mb-6">Create your first automation to start saving time.</p>
                <button onclick="router.navigate('dashboard')" class="text-brand-500 hover:underline">Go to Dashboard</button>
            </div>
        </section>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-dark-card border border-gray-700 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3">
            <i id="toast-icon" class="fa-solid fa-circle-check text-brand-500 text-xl"></i>
            <div>
                <h4 id="toast-title" class="font-bold text-sm">Success</h4>
                <p id="toast-msg" class="text-xs text-gray-400">Action completed successfully.</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
          // --- CONFIGURATION ---
        const CONFIG = {
            backendUrl: 'https://auto-me-backend.onrender.com',
            mockDelay: 800, // Simulate network delay if backend fails
            firebase: {
                apiKey: "AIzaSyBAwhYNk6eEVESzO5LbfvC2p_hwAB3t82k",
                authDomain: "auto-me-3e30e.firebaseapp.com",
                projectId: "auto-me-3e30e",
                storageBucket: "auto-me-3e30e.firebasestorage.app",
                messagingSenderId: "55458031917",
                appId: "1:55458031917:web:067750768672e03bf0cba4",
                measurementId: "G-4B6QWN6FKZ"
            }
        };

        // --- FIREBASE INIT ---
        firebase.initializeApp(CONFIG.firebase);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- STATE MANAGEMENT ---
        const state = {
            user: null,
            token: null,
            reels: [],
            automations: [],
            selectedReel: null
        };

        // --- ROUTER ---
        const router = {
            views: ['landing', 'dashboard', 'builder', 'automations'],
            navigate: (viewName) => {
                // Guard: Redirect to landing if not logged in
                if (!state.user && viewName !== 'landing') {
                    router.show('landing');
                    return;
                }
                
                // Active link styling
                document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('text-brand-500', 'bg-gray-800'));
                
                // Show requested view
                router.show(viewName);

                // Specific view logic
                if (viewName === 'dashboard') dataService.fetchReels();
                if (viewName === 'automations') dataService.fetchAutomations();
            },
            show: (id) => {
                router.views.forEach(v => document.getElementById(`view-${v}`).classList.add('hide'));
                document.getElementById(`view-${id}`).classList.remove('hide');
                
                const nav = document.getElementById('navbar');
                if (id === 'landing') nav.classList.add('hide');
                else nav.classList.remove('hide');
            }
        };

        // --- UI UTILS ---
        const ui = {
            toast: (title, msg, type = 'success') => {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toast-icon');
                
                document.getElementById('toast-title').innerText = title;
                document.getElementById('toast-msg').innerText = msg;
                
                if (type === 'error') {
                    icon.className = 'fa-solid fa-circle-xmark text-red-500 text-xl';
                } else {
                    icon.className = 'fa-solid fa-circle-check text-brand-500 text-xl';
                }

                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            },
            toggleKeywordInput: (show) => {
                const group = document.getElementById('keyword-group');
                if (show) group.classList.remove('hide');
                else group.classList.add('hide');
            },
            renderReels: (reels) => {
                const container = document.getElementById('reels-grid');
                container.innerHTML = '';
                
                if (!reels || reels.length === 0) {
                    container.innerHTML = '<div class="col-span-4 text-center text-gray-500">No reels found.</div>';
                    return;
                }

                reels.forEach(reel => {
                    const card = document.createElement('div');
                    card.className = 'glass-panel rounded-lg overflow-hidden hover:border-brand-500/50 transition cursor-pointer group';
                    card.onclick = () => automationService.openBuilder(reel);
                    
                    card.innerHTML = `
                        <div class="relative aspect-[9/16] bg-gray-800">
                            <img src="${reel.thumbnail_url || 'https://placehold.co/400x600/1e293b/white?text=No+Image'}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" onerror="this.src='https://placehold.co/400x600/1e293b/white?text=No+Image'">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="absolute bottom-3 left-3 text-white">
                                <div class="flex items-center gap-3 text-xs font-medium">
                                    <span><i class="fa-solid fa-play mr-1"></i> ${ui.formatNumber(reel.view_count || 0)}</span>
                                    <span><i class="fa-solid fa-heart mr-1"></i> ${ui.formatNumber(reel.like_count || 0)}</span>
                                </div>
                            </div>
                            <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition">
                                <span class="bg-brand-500 text-white text-xs font-bold px-2 py-1 rounded">SELECT</span>
                            </div>
                        </div>
                        <div class="p-4">
                            <p class="text-gray-400 text-xs line-clamp-2">${reel.caption || 'No caption'}</p>
                            <div class="mt-2 text-xs text-gray-500">${new Date(reel.timestamp || Date.now()).toLocaleDateString()}</div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },
            renderAutomations: (list) => {
                const container = document.getElementById('automations-list');
                const emptyState = document.getElementById('no-automations');
                container.innerHTML = '';

                if (!list || list.length === 0) {
                    emptyState.classList.remove('hide');
                    return;
                }
                emptyState.classList.add('hide');

                list.forEach(auto => {
                    const item = document.createElement('div');
                    item.className = 'glass-panel p-4 rounded-lg flex items-center justify-between group';
                    const activeClass = auto.active ? 'text-brand-500' : 'text-gray-500';
                    const triggerText = auto.triggerType === 'keyword' ? `Keyword: "${auto.keyword}"` : 'Any Comment';

                    item.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="h-16 w-12 bg-gray-800 rounded overflow-hidden flex-shrink-0">
                                <img src="${auto.reelThumbnail || 'https://placehold.co/100x150/1e293b/white?text=IMG'}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-white text-sm">${triggerText}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full border border-gray-700 ${auto.active ? 'bg-green-500/10 text-green-500' : 'bg-gray-700 text-gray-400'}">
                                        ${auto.active ? 'Active' : 'Paused'}
                                    </span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1 line-clamp-1">DM: ${auto.dmMessage}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="automationService.toggle('${auto.id}', ${!auto.active})" class="p-2 rounded-full hover:bg-gray-700 transition ${activeClass}" title="Toggle">
                                <i class="fa-solid fa-power-off"></i>
                            </button>
                            <button onclick="automationService.delete('${auto.id}')" class="p-2 rounded-full hover:bg-red-900/30 text-gray-500 hover:text-red-500 transition" title="Delete">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            },
            formatNumber: (num) => {
                if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
                if(num >= 1000) return (num/1000).toFixed(1) + 'K';
                return num;
            }
        };

        // --- AUTH SERVICE ---
        const authService = {
            login: async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    // Simulating "Instagram" Login via Google for Demo
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    
                    // Save to Firestore users collection as requested
                    await db.collection('users').doc(user.uid).set({
                        instagramId: 'insta_' + user.uid.substring(0, 8), // Mock ID
                        username: user.displayName,
                        email: user.email,
                        pageId: 'page_' + Date.now(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    ui.toast('Welcome back!', `Logged in as ${user.displayName}`);
                } catch (error) {
                    console.error("Login failed", error);
                    ui.toast('Login Failed', error.message, 'error');
                }
            },
            logout: () => {
                auth.signOut();
                router.navigate('landing');
            },
            monitor: () => {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        state.user = user;
                        document.getElementById('nav-user-name').innerText = user.displayName;
                        document.getElementById('nav-user-img').src = user.photoURL;
                        router.navigate('dashboard');
                    } else {
                        state.user = null;
                        router.navigate('landing');
                    }
                });
            }
        };
       // --- DATA SERVICE (Backend + Fallback) ---
        const dataService = {
            // Helper to handle API calls with mock fallback
            apiCall: async (endpoint, options = {}, mockData = null) => {
                try {
                    // Try Fetching from Backend
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout for check

                    const res = await fetch(`${CONFIG.backendUrl}${endpoint}`, {
                        ...options,
                        signal: controller.signal,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': state.user ? `Bearer ${await state.user.getIdToken()}` : ''
                        }
                    });
                    clearTimeout(timeoutId);

                    if (!res.ok) throw new Error(`API Error ${res.status}`);
                    return await res.json();

                } catch (error) {
                    console.warn(`Backend (${endpoint}) unreachable/failed:`, error);
                    // Fallback to Mock Data if backend fails
                    if (mockData) {
                        ui.toast('Dev Mode', 'Using local mock data (Backend unavailable)', 'success');
                        await new Promise(r => setTimeout(r, CONFIG.mockDelay)); // Simulate latency
                        return mockData;
                    }
                    throw error;
                }
            },

            fetchReels: async () => {
                document.getElementById('reels-loading').classList.remove('hide');
                document.getElementById('reels-grid').innerHTML = '';
                
                try {
                    // Mock Data for Reels
                    const mockReels = Array.from({length: 8}).map((_, i) => ({
                        id: `reel_${i}`,
                        caption: `This is an amazing reel description about product ${i+1}. Comment 'GUIDE' to get the link! #marketing #automation`,
                        media_url: 'video.mp4',
                        thumbnail_url: `https://images.unsplash.com/photo-${1611162616305 + i}?w=400&q=80`,
                        view_count: Math.floor(Math.random() * 50000) + 1000,
                        like_count: Math.floor(Math.random() * 2000) + 100,
                        timestamp: new Date().toISOString()
                    }));

                    const data = await dataService.apiCall('/reels', { method: 'GET' }, mockReels);
                    state.reels = data;
                    ui.renderReels(data);
                } catch (e) {
                    ui.toast('Error', 'Could not load reels', 'error');
                } finally {
                    document.getElementById('reels-loading').classList.add('hide');
                }
            },

            fetchAutomations: async () => {
                document.getElementById('automations-loading').classList.remove('hide');
                document.getElementById('automations-list').innerHTML = '';

                try {
                    // We try to fetch from Firestore directly for reliability in this demo
                    const snapshot = await db.collection('automations')
                        .where('userId', '==', state.user.uid)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const autos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.automations = autos;
                    ui.renderAutomations(autos);
                    
                } catch (e) {
                    console.error(e);
                    // Mock Automations fallback
                    const mockAutos = [
                        { id: '1', reelThumbnail: 'https://images.unsplash.com/photo-1611162616305?w=100', active: true, triggerType: 'keyword', keyword: 'PRICE', dmMessage: 'It is $20.' }
                    ];
                    ui.renderAutomations(mockAutos);
                } finally {
                    document.getElementById('automations-loading').classList.add('hide');
                }
            }
        };

        // --- AUTOMATION SERVICE ---
        const automationService = {
            openBuilder: (reel) => {
                state.selectedReel = reel;
                
                // Populate Preview
                document.getElementById('builder-thumbnail').src = reel.thumbnail_url;
                document.getElementById('builder-caption').innerText = reel.caption;
                document.getElementById('builder-views').innerText = ui.formatNumber(reel.view_count);
                document.getElementById('builder-likes').innerText = ui.formatNumber(reel.like_count);

                // Populate Form Hidden Fields
                document.getElementById('form-reel-id').value = reel.id;
                document.getElementById('form-reel-url').value = reel.permalink || '';
                document.getElementById('form-reel-thumb').value = reel.thumbnail_url;

                // Reset Form
                document.getElementById('automation-form').reset();
                ui.toggleKeywordInput(true); // Default
                
                router.navigate('builder');
            },

            save: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('save-btn');
                const btnText = document.getElementById('save-btn-text');
                const loader = document.getElementById('save-btn-loader');

                // Loading State
                btn.disabled = true;
                btnText.innerText = 'Saving...';
                loader.classList.remove('hide');

                // Gather Data
                const formData = {
                    userId: state.user.uid,
                    reelId: document.getElementById('form-reel-id').value,
                    reelThumbnail: document.getElementById('form-reel-thumb').value,
                    triggerType: document.querySelector('input[name="triggerType"]:checked').value,
                    keyword: document.getElementById('form-keyword').value,
                    followRequired: document.getElementById('form-follow-required').checked,
                    dmMessage: document.getElementById('form-message').value,
                    buttonText: document.getElementById('form-btn-text').value,
                    buttonUrl: document.getElementById('form-btn-url').value,
                    autoReplyComment: document.getElementById('form-reply').value,
                    active: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp
                };

                try {
                    // 1. Save to Firestore (Primary Truth)
                    await db.collection('automations').add(formData);

                    // 2. Call Backend API (Notification/Processing)
                    // We don't await this strictly to keep UI snappy, or we swallow errors if backend is down
                    dataService.apiCall('/save-automation', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    }, { success: true }).catch(err => console.log('Backend sync skipped'));

                    ui.toast('Automation Active', 'Your DM automation is now running.');
                    router.navigate('automations');
                } catch (error) {
                    console.error(error);
                    ui.toast('Save Failed', 'Could not save automation.', 'error');
                } finally {
                    btn.disabled = false;
                    btnText.innerText = 'Activate Automation';
                    loader.classList.add('hide');
                }
            },

            toggle: async (id, isActive) => {
                try {
                    // Optimistic update
                    const idx = state.automations.findIndex(a => a.id === id);
                    if (idx > -1) {
                        state.automations[idx].active = isActive;
                        ui.renderAutomations(state.automations);
                    }

                    await db.collection('automations').doc(id).update({ active: isActive });
                    
                    // Backend Sync
                    dataService.apiCall('/toggle-automation', {
                        method: 'POST',
                        body: JSON.stringify({ id, active: isActive })
                    }, { success: true }).catch(console.warn);

                } catch (error) {
                    ui.toast('Error', 'Could not update status', 'error');
                    dataService.fetchAutomations(); // Revert on error
                }
            },

            delete: async (id) => {
                if(!confirm('Are you sure you want to delete this automation?')) return;
                try {
                    await db.collection('automations').doc(id).delete();
                    
                    state.automations = state.automations.filter(a => a.id !== id);
                    ui.renderAutomations(state.automations);
                    ui.toast('Deleted', 'Automation removed.');
                } catch (error) {
                    ui.toast('Error', 'Could not delete', 'error');
                }
            }
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            authService.monitor();
        });

    </script>
</body>
</html>
